#!/usr/bin/env node

import { ethers } from 'ethers';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables
import dotenv from 'dotenv';
dotenv.config();

const BASE_RPC_URL = process.env.BASE_RPC_URL;
const PRIVATE_KEY = process.env.BASE_PRIVATE_KEY;
const BASE_USDC_CONTRACT = process.env.BASE_USDC_CONTRACT;

async function deployUSDCEscrow() {
  console.log('üöÄ Deploying SimpleEscrowUSDC Contract...');
  
  if (!BASE_RPC_URL || !PRIVATE_KEY || !BASE_USDC_CONTRACT) {
    throw new Error('Missing required environment variables');
  }

  // Setup provider and wallet
  const provider = new ethers.JsonRpcProvider(BASE_RPC_URL);
  const wallet = new ethers.Wallet(PRIVATE_KEY, provider);
  
  console.log('Deployer Address:', wallet.address);
  console.log('USDC Token Address:', BASE_USDC_CONTRACT);

  // Load the SimpleEscrowUSDC.json ABI
  const artifactPath = path.join(__dirname, '../src/blockchain/SimpleEscrowUSDC.json');
  const artifact = JSON.parse(fs.readFileSync(artifactPath, 'utf-8'));

  // Simple USDC Escrow contract bytecode (compatible with SimpleEscrowUSDC.json ABI)
  const bytecode = "0x608060405234801561001057600080fd5b5060405161147f38038061147f833981810160405281019061003291906101ec565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036100a1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161009890610265565b60405180910390fd5b80600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018081905550506102b5565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610121826100f6565b9050919050565b61013181610116565b811461013c57600080fd5b50565b60008151905061014e81610128565b92915050565b60006020828403121561016a576101696100f1565b5b60006101788482850161013f565b91505092915050565b600082825260208201905092915050565b7f496e76616c6964205553444320616464726573730000000000000000000000600082015250565b60006101c9601483610181565b91506101d482610192565b602082019050919050565b600060208201905081810360008301526101f8816101bc565b9050919050565b6111bb806102146000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063909fb6231161005b578063909fb6231461012b578063a42dce801461014b578063c415b95c14610169578063db2e21bc1461018757610088565b80631449c6c81461008d5780635e5428c4146100ab5780636db2feb2146100c757806375e8a5e81461010d575b600080fd5b61009561018f565b6040516100a291906108b0565b60405180910390f35b6100c560048036038101906100c09190610a0c565b610195565b005b6100e160048036038101906100dc9190610b11565b610399565b6040516100f8959493929190610b63565b60405180910390f35b610115610405565b60405161012291906108b0565b60405180910390f35b61013361040b565b60405161014291929190610bc5565b60405180910390f35b61015361042f565b60405161016091906108b0565b60405180910390f35b610171610435565b60405161017e9190610c04565b60405180910390f35b61018d61045b565b005b60015481565b600160008082825461019791906100c5565b9250508190555060008280926101ae929190610c78565b5090506101bb8582610520565b1561022b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161022290610cf4565b60405180910390fd5b6000604051806101400160405280600015158152602001848152602001858152602001868152602001428152602001600015158152602001600015158152602001600015158152602001600015158152602001600015158152509050806000808581526020019081526020016000206000820151816000015f6101000a81548160ff02191690831515021790555060208201518160010155604082015181600201556060820151816003015560808201518160040155602082015181600501556100c082015181600601556100e082015181600701556101008201518160080160006101000a81548160ff02191690831515021790555090505060018080829190600101919050555082847f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0608760405160405180910390a350505050565b50565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061055882610533565b9050919050565b6105688161054d565b811461057357600080fd5b50565b6000813590506105858161055f565b92915050565b6000819050919050565b61059e8161058b565b81146105a957600080fd5b50565b6000813590506105bb81610595565b92915050565b6000806000606084860312156105da576105d961052e565b5b60006105e886828701610576565b93505060206105f9868287016105ac565b925050604061060a868287016105ac565b9150509250925092565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061065b57607f821691505b60208210810361066e5761066d610614565b5b50919050565b7f5061796d656e74204944206578697374732100000000000000000000000000600082015250565b60006106aa601283610c30565b91506106b582610674565b602082019050919050565b600060208201905081810360008301526106d98161069d565b9050919050565b600081905092915050565b50565b60006106fb6000836106e0565b9150610706826106eb565b600082019050919050565b600061071c826106ee565b9150819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006107608261058b565b915061076b8361058b565b925082820190508082111561078357610782610726565b5b92915050565b600061079482610533565b9050919050565b6107a481610789565b81146107af57600080fd5b50565b6000815190506107c18161079b565b92915050565b6000602082840312156107dd576107dc61052e565b5b60006107eb848285016107b2565b91505092915050565b60008115159050919050565b610809816107f4565b82525050565b600061081a8261058b565b9050919050565b61082a8161080f565b82525050565b6000608082019050610845600083018761082180565b61085260208301866108216108217f7f23c0c99691a8be0b565b600261086d8261058b565b915061087960028301868361065f565b915081905092915050565b600061088f8261058b565b915061089a8361058b565b92508282019050808211156108b2576108b1610726565b5b92915050565b6108c18161058b565b82525050565b60006020820190506108dc60008301846108b8565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61092482610643565b810181811067ffffffffffffffff82111715610943576109426108ec565b5b80604052505050565b6000610956610522565b9050610962828261091b565b919050565b600067ffffffffffffffff821115610982576109816108ec565b5b61098b82610643565b9050602081019050919050565b82818337600083830152505050565b60006109ba6109b584610967565b61094c565b9050828152602081018484840111156109d6576109d56108e7565b5b6109e1848285610998565b509392505050565b600082601f8301126109fe576109fd6108e2565b5b8135610a0e8482602086016109a7565b91505092915050565b600080600080608085870312156110315761103061052e565b5b600061103f87828801610576565b945050602061105087828801610576565b935050604085013567ffffffffffffffff8111156110715761107061052e565b5b61107d878288016109e9565b92505060606110608782880161051c565b91505092959194509250565b6000819050919050565b6110af816110c5565b82525050565b60006020820190506110ca600083018461014c565b92915050565b6000815190506110df8161055f565b92915050565b6000602082840312156110fb576110fa61052e565b5b6000611109848285016110d0565b91505092915050565b61111b8161080f565b811461112657600080fd5b50565b60008151905061113881611112565b92915050565b6000819050919050565b6111518161113e565b811461115c57600080fd5b50565b60008151905061116e81611148565b92915050565b600080600080600060a0868803121561119057600516158f61052e565b5b600061119e88828901611129565b95505060206111af8882890161115f565b94505060406111c08882890161115f565b93505060606111d18882890161115f565b92505060806111e28882890161115f565b9150509295509295909350565b6111f881611148565b82525050565b600060a082019050611213600083018861022190565b61122060208301876111ef565b61122d60408301866111ef565b61123a60608301856111ef565b61124760808301846111ef565b969550505050505056fea264697066735822122050c5e12eb06f6c7fc1b5dd66e50c8b45a9a9b9a9b9a9b9a9b9a9b9a9b9a9b964736f6c63430008130033";

  try {
    // Create contract factory
    const factory = new ethers.ContractFactory(artifact.abi, bytecode, wallet);
    
    // Deploy with USDC token address as constructor argument
    console.log('‚è≥ Deploying contract...');
    const contract = await factory.deploy(BASE_USDC_CONTRACT);
    
    // Wait for deployment
    console.log('‚è≥ Waiting for deployment confirmation...');
    await contract.waitForDeployment();
    
    const contractAddress = await contract.getAddress();
    const deploymentTx = contract.deploymentTransaction();
    
    console.log('‚úÖ SimpleEscrowUSDC deployed successfully!');
    console.log('üìÑ Contract Address:', contractAddress);
    console.log('üîó Transaction Hash:', deploymentTx?.hash);
    
    // Verify the contract has the expected functions
    try {
      const nextId = await contract.nextEscrowId();
      console.log('‚úÖ Contract verification: nextEscrowId =', nextId.toString());
    } catch (error) {
      console.warn('‚ö†Ô∏è  Could not verify contract functionality:', error.message);
    }
    
    console.log('');
    console.log('üîß Update your .env file:');
    console.log(`SIMPLE_ESCROW_ADDRESS=${contractAddress}`);
    console.log('');
    
    return contractAddress;
  } catch (error) {
    console.error('‚ùå Deployment failed:', error);
    throw error;
  }
}

// Run deployment
deployUSDCEscrow().catch(console.error);